@page "/reservations"
@inject TodoServerApp.Services.BookingService BookingService
@rendermode InteractiveServer

@using TodoServerApp.Models

<div class="mb-4">
    <h1>Все бронирования</h1>

    @if (reservations == null || reservations.Count == 0)
    {
        <p>Бронирований пока нет.</p>
    }
    else
    {
        <div class="reservation-card">
            <table class="table table-striped mb-0">
                <thead class="thead-dark">
                    <tr>
                        <th>Столик</th>
                        <th>Имя клиента</th>
                        <th>Дата и время</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var res in reservations)
                    {
                        var table = tables.FirstOrDefault(t => t.Id == res.TableId);
                        DateTime endTime = res.DateTime.AddHours(1);
                        <tr>
                            <td>@(table?.Name ?? "Неизвестно")</td>
                            <td>@res.ClientName</td>
                            <td>@res.DateTime.ToString("dd.MM.yyyy HH:mm") - @endTime.ToString("HH:mm")</td>
                            <td>
                                <button class="btn btn-danger btn-sm" @onclick="() => DeleteReservation(res.Id)">Удалить</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<Reservation> reservations = new();
    private List<Table> tables = new();

    protected override void OnInitialized()
    {
        LoadData();
    }

    private void LoadData()
    {
        // Сортируем брони по дате — ближайшие сверху
        reservations = BookingService.GetReservations()
            .OrderBy(r => r.DateTime)
            .ToList();
        tables = BookingService.GetTables();
    }

    private void DeleteReservation(int id)
    {
        BookingService.DeleteReservation(id);
        LoadData();
    }
}
